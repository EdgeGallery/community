# 安全设计规范

本文档根据行业标准和开源最佳实践开发，可指导开发人员进行模块设计并避免高安全性设计风险。
对于本指南中的每条规则，都提供了一些测试步骤，以帮助开发人员设计和实现测试用例。

## 1.识别，认证和授权

1.1所有用于跨网络传输的机器对机器和人对机器接口都必须具有访问认证机制，并且认证过程必须在服务器上执行。
**注意**：跨网络接口必须支持身份验证，以防止欺骗访问。

测试步骤：
1.列出所有机器对机器和人对机器接口。
2.检查所有接口以确认身份验证机制的存在并记录结果。

测试工具：
telnet，snmp，ssh，ftp，sftp，netconf

1.2对于每个需要授权的访问请求，服务器必须验证用户是否有权执行此操作。
**注意**：未经授权的URL访问是一个典型的Web安全漏洞。攻击者可以轻松绕过系统权限控制来访问系统资源并未经授权使用系统功能。为了防止用户直接输入URL来未经授权就请求和执行某些页面，后台需要验证请求URL的用户的权限。
测试绕过身份验证架构

测试步骤：
1.设计水平特权升级测试用例，以验证授权机制的存在。例如用户A尝试访问用户B的资源。
2.设计垂直特权升级测试用例，以验证授权机制的存在。例如用户尝试执行超出其许可范围的操作或使用功能。
3.参数修改  例如修改请求中的参数，尝试    
4.SQL注入

测试工具： WebGoat；OWASP Zed Attack Proxy (ZAP)

1.3服务器必须验证所有不受信任的数据源的大小，类型，长度和特殊字符，并拒绝所有未通过验证的数据。
**注意**：为了防止攻击者通过代理来拦截和篡改请求以绕过客户端的有效性检查，必须在服务器上执行数据验证。

测试步骤：
1.查看代码以确认所有API均验证所有不受信任的数据源的大小，类型，长度和特殊字符。
2.设计测试用例以调用具有abnoraml数据有效负载的API，并确认所有未通过验证的数据将被拒绝。

1.4禁止在绕过系统安全性机制的同时允许访问系统或数据的功能（例如身份验证，权限控制和日志记录）。
**注意**：如果产品具有无需系统安全性机制即可访问系统或数据的功能，恶意人员可能会意识到这些功能并在未经授权的情况下执行操作，这会严重影响系统。

测试步骤：
1.查看代码以确认允许访问系统或数据不能绕过系统安全机制的功能。
2.进行渗透测试以验证没有办法绕过系统安全机制。

测试工具：
OWASP ZAP，Postman

1.5根据最小特权原则，用于运行软件程序的帐户是低特权OS帐户。
**注意**：特权帐户（例如root，administrator和超级用户）或高级帐户不能用于运行软件程序。而是使用普通帐户运行软件程序。

测试步骤：
1.查看Dockerfile以确认Docker以非root用户身份运行。
2.设计特权升级脚本以验证文件许可权和文件所有者设置是否正确。

1.6可能重新获得对帐户访问权限的帐户身份验证功能（例如更新配置文件，忘记密码，禁用/丢失的令牌，帮助台或IVR）至少具有与主要身份验证机制相同的抵抗攻击能力。

测试步骤：
待定

1.7所有身份验证控件必须安全失败。
**注意**：开发人员必须正确处理错误消息的显示。

测试步骤：
1.对于每种身份验证方案，实施各种身份验证失败，即不存在用户，密码错误，未经许可的用户。
2.检查系统界面中显示的错误消息和日志中记录的错误消息，确认消息正确。

1.8忘记的密码功能和其他恢复路径不应泄露当前密码，新密码也不应以明文形式发送给用户。

测试步骤：
1.登录系统并使用“忘记密码”功能重置密码。
2.检查当前密码未显示，并且新密码已加密。

1.9更改密码功能必须包括旧密码，新密码和密码确认。

测试步骤：
1.登录系统并使用更改密码功能，检查界面包括旧密码，新密码和密码确认。

1.10 确认已采取措施阻止使用常用的密码和弱密码短语。

测试步骤：
1.登录系统并使用更改密码功能，尝试将密码更改为常用密码和弱密码。
2.确认由于使用常用的密码和较弱的密码短语而导致操作失败。

1.11确保没有捕获-重放攻击的可能性。version：v1.0
注意：当软件的设计使恶意用户有可能通过将其重放到服务器来使恶意用户嗅探网络流量并绕过身份验证时，存在捕获-重放缺陷。利用某些序列或时间戳记功能以及将这一点考虑在内的校验和为了确保消息只能被解析一次。（此规则将在R1.0 *中生效）

测试步骤：

通过侦听身份验证数据包并尝试使用相同的内容重播它，不应允许其登录，并且身份验证必须失败。

1.12基于角色的访问控制。version：v1.0
注意：必须定义并遵循基于角色的访问控制，才能访问系统中的资源。适用于用户以及应用程序。（此规则将在R1.0 *中生效）

测试步骤：

为不同的用户设置不同的特权。
交叉检查仅特权用户可以访问资源。



## 2.安全传输

2.1敏感数据（包括密码）或关键服务数据（网络结构，模型参数）必须使用安全传输协议在网络上传输，或者在传输之前进行加密。
**注意**：跨网络传输数据时，容易受到攻击者的窃取或篡改。因此，必须保护重要数据。

测试步骤：
1.根据端口通信文档，使用openssl扫描每个端口并确认默认情况下启用了HTTPS。

测试工具：
openssl

2.2请勿使用SSL2.0，SSL3.0，TLS1.0或TLS1.1进行安全传输。建议使用TLS1.2和TLS1.3。
**注意**：由于安全问题，Internet工程任务组（IETF）已于2011年3月和2015年6月禁用了安全套接字层（SSL）2.0和SSL 3.0。在传输层安全性（TLS）1.0中，对称加密算法仅支持RC4算法和块密码算法的密码块链接（CBC）模式。 RC4算法被认为是不安全的，并且在所有TLS版本中均被IETF禁用。对称加密算法的CBC模式存在可预测的初始化向量（IV）的问题，并且容易受到BEAST攻击。因此，建议使用TLS 1.2和TLS 1.3。

测试步骤：
1.使用openssl扫描部署环境中的端口，确认已禁用SSL2.0，SSL3.0，TLS1.0和TLS1.1。

测试工具：
openssl

2.3必须启用并配置适当的证书吊销，例如在线证书状态协议（OCSP）装订。

测试步骤：
1.审核代码并确认证书撤销机制的实施。

2.4 测试弱传输层安全性

测试步骤：
1.验证服务配置。
2.测试确保TLS安全性不可绕过并且在整个应用程序中正确实现。



## 3.敏感和私有数据保护

3.1身份验证凭据（例如密码和密钥）不能以纯文本格式存储在系统中，必须进行加密。如果不需要恢复纯文本，请使用不可逆的PBKDF2算法进行加密。如果需要恢复纯文本，则可以使用AES-256 GCM算法进行加密。

测试步骤：
1.检查凭据加密机制，并确认用户凭据在存储之前已加密。

3.2避免将密码存储在易于访问的位置。考虑存储密码的加密散列，以代替以明文形式存储。

测试步骤：
待定

3.3所有敏感数据都通过HTTP消息正文发送到服务器（即，URL参数从不用于发送敏感数据）。

测试步骤：
1.查看代码并确认敏感数据未作为URL参数传输。
2.使用API​​工具（例如Postman）进行验证。

测试工具：
Postman

3.4默认情况下，不能直接读取数据主体的个人数据。如有必要，提供一个接口以获取数据主体的授权。
**注意**：个人数据属于数据主体。如果需要访问和收集个人数据，则需要数据主体的同意和授权。



测试步骤：
1.检查系统，检查是否存在获得数据主体同意和收集个人数据授权的接口。

3.5默认情况下，在应用程序处理期间生成的数据无法传输给第三方。如有必要，提供一个接口以获取数据主体的授权。
**注意**：在将数据主体的个人数据传输给第三方之前，请提供一种合理的方法，将要传输的个人数据的类型，传输目的和有关数据接收者的信息通知数据主体，并获取数据主体的同意。

测试步骤：
1.检查系统，检查是否存在获取数据主体授权将数据传输到第三方的接口。

3.6如果需要将个人数据用于市场营销，用户配置文件和市场调查，则提供一个接口以获取数据主体的授权，并提供一个接口以供数据主体随时撤消其授权。
**注意**：如果将个人数据用于用户配置文件和市场营销，则必须获得明确的用户授权，以便用户可以选择是否将其个人数据用于基本服务。出售给欧盟的产品或系统，如果涉及用户配置文件和市场营销，则除了通知用户外，还必须告知用户其用户配置文件逻辑，拒绝提供个人数据的后果以及是否将个人数据转移到欧洲经济区（EEA）外他们有权拒绝。

测试步骤：
1.检查系统，检查是否存在获取数据主体授权的接口和数据主体撤消授权的接口。

3.7 测试浏览器缓存不足 version：v1.0
使用“后退”按钮可以允许用户（或攻击者）返回到先前显示的屏幕。测试人员单击浏览器的“后退”按钮，以检查未经身份验证的用户是否可以访问以前显示的敏感信息。

3.8 测试不安全的直接对象引用 version：v1.0
不安全的对象直接引用（Insecure direct object references），指一个已经授权的用户，通过更改访问时的一个参数，从而访问到了原本其并没有得到授权的对象
服务器上的具体文件名、路径或数据库关键字等内部资源被暴露在URL或网页中，攻击者可以尝试直接访问其他资源。
1.避免在URL或网页中直接引用内部文件名或数据库关键字。
2.可使用自定义的映射名称来取代直接对象名，例如， http://example.test/online/news.asp?item=0245等
3.锁定网站服务器上的所有目录和文件夹，设置访问权限。
4.验证用户输入和URL请求，拒绝包含./或../的请求

## 4.加密算法和密钥管理

4.1请勿使用专有和非标准的加密算法。
**注意**：专有和非标准密码算法不能在产品中使用。一方面，难以确保由非密码专业人员设计的密码算法的安全强度。另一方面，这样的算法在行业中未被分析和验证，并且可能具有未知的缺陷。另外，这种设计违反了开放和透明的安全设计原则。建议使用行业中常见的开源密码组件，例如OpenSSL和OpenSSH。

测试步骤：
1.检查代码，并确认未使用专有和非标准的加密算法。

4.2不要使用不安全的密码算法。建议使用强密码算法。
**注意**：随着加密技术的发展和计算能力的提高，一些加密算法不再适用于当前的安全领域，例如不安全的对称加密算法DES和RC4，不安全的非对称加密算法RSA-1024，不安全的哈希算法SHA-0，SHA-1，MD2，MD4和MD5，以及不安全的密钥协商算法DH-1024。相反，建议使用AES-256，RSA-3072，SHA-256，PBKDF2或更强的加密算法。

测试步骤：
1.检查代码，并确认使用了强低温密码套件。
2.用户openssl扫描每个端口以验证使用的密码套件。
        
4.3用于加密数据的密钥不能进行硬编码。
**注意**：密钥必须是可更换的，以防止由于长期使用而造成的披露风险。

测试步骤：
1.检查代码并确认键是否可配置。

4.4为了安全起见，请使用加密安全的随机数。
**注意**：随机数用于加密算法，例如IV，盐和密钥的生成。不安全的随机数会使键和IV部分或完全可预测。密码安全的随机数必须不可预测。

测试步骤：
1.检查代码，并确认使用加密安全的随机数。

4.5使用安全的随机数生成器生成密钥。
**注意**：如果密钥是由随机数生成器生成的，则随机数生成器必须是安全的。如果使用不安全的随机数生成器，则可以预测获得的密钥。例如，可以在OpenSSL库中使用RAND_bytes，在Linux OS中使用/dev/random设备接口，在Trusted Platform Module（TPM）中使用RNG。

测试步骤：
1.检查代码并确认使用了随机数生成器。

4.6重用随机数，禁止加密中的密钥对。version：v1.0
注意：现时只能使用Nonce，并且只能使用一次。使用诸如要求递增，基于时间和/或质询响应的技术以确保随机数的唯一性。（此规则将在R1.0 *中生效）

测试步骤：

检查代码并确认Nonce总是重新生成而不是重用。



## 5. DOS攻击

5.1必须具备反自动化功能，以防止违反凭据测试，暴力破解和帐户锁定攻击。

测试步骤：
1.设计用户登录脚本以模拟残酷的登录尝试，确认用户帐户将被锁定。
2.使用JMeter针对API模拟DOS attcck，检查系统的运行状态。

测试工具：
JMeter

5.2应用程序必须限制活动的并发会话数。

测试步骤：
1.设计测试用例以建立尽可能多的并发会话，并确认同时进行的并发会话数。

5.3所有输入必须限制在适当的大小限制内。

测试步骤：
1.检查代码，以确认输入大小验证用于不受信任资源中的任何数据。
2.设计测试用例，以调用具有超大有效负载的API，以确认输入大小的验证功能正常。



## 6.会话管理

6.1验证用户身份，否则，用于建立新的用户会话。在不使任何现有会话标识符无效的情况下，攻击者就有机会窃取经过身份验证的会话。
**注意**：在授权新的用户会话之前，请使所有现有的会话标识符无效。

测试步骤：
1.（用户A）登录系统，记录会话标识。
2.（用户A）使用另一个客户端登录系统。
3.确认步骤1中生成的渗透标识符已无效。

6.2将会话/凭证设置为有效的到期日期。

测试步骤：
1.登录系统，并确认会话和凭据具有有效的到期日期。

6.3保护应用程序的会话免受信息泄漏。确保会话的数据未被其他会话使用或不可见。

测试步骤：

6.4用户注销时，会话必须无效。

测试步骤：
1.注销系统，并确认会话已无效。

6.5成功的身份验证和重新身份验证必须生成新的会话和会话ID。

测试步骤：
1.登录系统并记录会话ID。
2.注销然后再次登录系统，将会话ID与上一个进行比较，确认会话ID不同。

6.6 测试暴露的会话变量  version：v1.0
   1.测试缓存漏洞 ，每当传递会话ID时，都应使用指令以防止中间缓存甚至本地缓存对其进行缓存。
   2. GET和POST漏洞， 不应使用GET请求，因为会话ID可能会在代理或防火墙日志中公开



## 7. Web服务安全性

7.1客户端和服务器之间必须具有相同的编码样式。
**注意**：客户端和服务器之间的不同编码可能会影响安全性，并且过去已用于绕过验证和WAF来执行XSS攻击。

测试步骤：
1.检查代码以确认使用相同的编码样式。

7.2必须接受XML或JSON模式，并在接受输入之前对其进行验证。
**注意**：模式验证是针对应用程序逻辑攻击的第一级防御。

测试步骤：
1.检查代码以确认XML和JSON模式验证已实现。
2.设计测试用例，以调用具有异常XML或JSON有效负载的API来验证架构验证是否有效，并确认所有未通过验证的数据将被拒绝。

7.3 测试会话管理架构 version：v1.0
**注意** ：测试人员希望检查是否以安全且不可预测的方式创建了cookie和其他会话令牌。能够预测和伪造弱Cookie的攻击者可以轻松劫持合法用户的会话。
测试项目：
是否有任何Cookie操作通过未加密的传输进行？
可以将Cookie强制通过未加密的传输吗？
是否存在任何持久性Cookies？
会话ID的哪些部分是静态的？
会话ID中存储了哪些明文机密信息？例如用户名/ UID，IP地址
存储了哪些容易解码的机密信息？
从会话ID的结构中可以推断出哪些信息？
对于相同的登录条件，会话ID的哪些部分是静态的？
会话ID整体或各个部分中有哪些明显的模式？
会话ID本质上是否可证明是随机的？可以重现结果值吗？
相同的输入条件在后续运行中是否产生相同的ID？
会话ID是否被证明可以抵抗统计或密码分析？
会话ID的哪些元素是时间相关的？
会话ID的哪些部分是可预测的？
在完全了解生成算法和先前ID的情况下，是否可以推断出下一个ID？
Cookie是否由包含不同信息的不同子部分组成？各个部分如何分离？使用哪个定界符？

测试步骤：
1. 检查id本身，以从安全角度确保其质量，随机性，唯一性，统计和密码分析的抵抗力，信息泄露等方面进行分析。
2.手动执行，也可以使用密码分析工具来推断出Session ID内容中的任何模式，以确定是否存在任何可识别或可预测的模式。检查会话ID的哪些元素是时间相关的？会话ID的哪些部分是可预测的？

7.4 所有cookie都已设置，并且正在实施正确的安全配置。version：v1.0
  
**注意** ：应用程序应正确的使用了每个属性，比如 安全属性；httpOnly属性；路径属性；过期属性；可以使用拦截代理来查看Cookie，也可以通过查看浏览器的Cookie来查

7.5避免将Cookie数据用于与安全相关的决策。version：v1.0
（此规则将在R1.0中生效） 注意：攻击者可以在浏览器内或通过在浏览器外部实施客户端代码来轻松修改cookie。攻击者可以通过将cookie修改为包含期望值来绕过授权和身份验证之类的保护机制。

测试步骤：

尝试登录系统而不删除或清除cookie。
确保cookie不参与身份验证过程，也就是说，整个身份验证是使用密码或其他有效的身份验证机制进行的。

7.6 测试跨站请求伪造：version：v1.0
   攻击者可能会迫使Web应用程序的用户执行攻击者选择的操作，确定是否有可能代表用户发起不是由用户发起的请求，
   1.在服务端验证HTTP Referer字段比如request.getHeader("Referer").
   2.在请求地址中添加token验证，比如session.getAttribue("token"),然后将token放在seesion里面，获取攻击者发送过来的请求里面的token进行 
     比较.



## 8.安全文件

8.1所有公共功能接口，RESTful接口，本地功能接口，命令行接口以及用于身份验证的默认用户名和密码都必须在产品或应用程序文档中进行描述。
**注意**：必须在应用文档中描述所有前面的新接口，以帮助用户更好地理解相应的模块。

测试步骤：
1.列出所有公共功能接口，RESTful接口，本地功能接口，命令行接口。
2.检查所有接口，产品或应用程序文档中描述了用于身份验证的默认用户名和密码。

8.2系统运行和维护需要外部通讯连接。必须在端口矩阵文档中描述所有使用的通信端口。动态监听端口必须限制在适当范围内。
**注意**：如果端口矩阵文档中未描述外部通信端口，则可能会影响用户安全配置。

测试步骤：
1.使用NMap扫描部署环境中的端口，并将扫描结果与端口矩阵文档进行比较。验证所有端口都记录在端口矩阵文档中。

测试工具：
地图

## 9.日志安全

9.1请勿记录未经消毒的用户输入。
**注意**：未经消毒的日志记录可能使攻击者伪造日志条目或将恶意内容注入日志。

测试步骤：
1.检查系统日志，确认没有包括未消毒的用户日期。

9.2足够的日志记录。
**注意**：确保记录所有与安全相关的成功和失败。如果没有正确记录安全性至关重要的事件（例如登录尝试失败），这将使恶意行为更难以检测，并且可能会阻止攻击成功后的取证分析。

测试步骤：
1.检查系统日志，并确认已记录所有与安全相关的成功和失败。

9.3请勿将敏感信息添加到日志或日志文件中。
**注意**：请认真考虑写入日志文件的信息的敏感性。不要将机密信息写入日志文件。在将应用程序部署到生产环境之前，请删除调试日志文件。保护日志文件免遭未经授权的读/写。

测试步骤：
1.检查系统日志，并确认未记录任何敏感数据。

9.4避免记录过多的数据。
**注意**：禁止大量重复的日志消息，并用定期摘要替换它们。例如，syslog可能包含一个条目，该条目在记录重复事件时声明“最后消息重复X次”。支持可以由管理员控制的日志文件的最大大小。

测试步骤：
1.检查系统日志，并确认仅记录最小数据。

## 10.威胁建模

10.1所有功能设计必须进行威胁建模，并检查设计中是否考虑了安全性的所有方面。
**注意**：威胁建模是一个过程，可以分析产品的体系结构并确定产品设计中的安全性问题。有关更多详细信息，请参阅https://gitee.com/edgegallery/community/blob/master/Security%20WG/Secure%20Design/Threat%20Modeling%20--%20STRIDE.md

测试步骤：
对于每种缓解方法：
1.设计一个测试用例，以检查缓解方法的实现正确性；
2.设计一个测试用例，从攻击者的角度攻击系统，并验证缓解方法的有效性。

## 外部引用
1. https://gdpr-info.eu/
2. https://gitee.com/mindspore/community/tree/master/security
3. http://cwe.mitre.org/data/definitions/1008.html
4. https://github.com/devonfw/devonfw-security/wiki/guide-security-quick-owasp-asvs
5. https://github.com/OWASP/wstg/blob/master/document/4-Web_Application_Security_Testing/06-Session_Management_Testing/README.md 
6. https://wiki.owasp.org/index.php/OWASP_Testing_Project 
7. https://ico.org.uk/for-organisations/guide-to-data-protection/guide-to-the-general-data-protection-regulation-gdpr/encryption/how-should-we-implement-encryption/ 
